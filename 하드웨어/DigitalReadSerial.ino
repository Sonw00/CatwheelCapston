#include <Stepper.h>

const int STEPS = 2048;              //  λ¨ν„° ν•λ°”ν€΄ (360λ„) μ¤ν…μ [λ³€κ²½λ¶κ°€]
Stepper eatmotor(STEPS, 11,9,10,8);  //  λ¨ν„° ν•€


int IRdetect = 3;              //  IR κ±°λ¦¬μΈ΅μ •μ„Όμ„ ν•€λ²νΈ : 3
int eatDetectpin = 2;          //  λ¨Ήμ΄ν†µκ°μ§€μ„Όμ„ ν•€λ²νΈ : 2
int eatNoDetectCount = 0;      //  λ¨Ήμ΄ν†µ μ μ™Έμ„  μ„Όμ„κ°€ μ—°μ†μΌλ΅ λΉ λ¨Ήμ΄ν†µμ„ κ°μ§€ν•  λ• μ“°μ΄λ” λ³€μ. μ„Όμ„ μ •ν™•λ„ ν–¥μƒμ— μ“°μ„.
int previouslySenserVel = 0;   //  IR μƒνƒλ³€ν™” ν™•μΈ
int tick = 0;                  //  IR κ±°λ¦¬μΈ΅μ •μ„Όμ„ ν‹±νμ (1ν‹±μ— 2μ„Όν‹°λ―Έν„°)
int eatamount = 1;             //  λ¨Ήμ΄ λ‚μ¤λ” μ–‘ μ΅°μ  (1μ€ λ¨ν„° 1λ°”ν€΄ νμ „)
int eatCycle = 20;             //  λ‡ ν‹±μ‚¬μ΄ν΄λ§λ‹¤ λ¨Ήμ΄λ¥Ό μ¤„κ±΄μ§€ μ„¤μ •(1ν‹±μ€ 2μ„Όν‹°λ―Έν„°)
int IsMotorSpin = 0;          //  ν„μ¬ λ¨ν„°κ°€ μ¤ν•€μ¤‘μΈκ°€ μ•„λ‹κ°€λ¥Ό μ €μ¥ν•λ” bool
int HowMuchSpinMotor= 0;       //  λ¨ν„°κ°€ ν„μ¬ μ–Όλ§λ§νΌ νμ „ν–λ”μ§€λ¥Ό μ €μ¥ν•λ” μ „μ—­λ³€μ(ν•λ°”ν€΄ = 1024)


void setup() {
  eatmotor.setSpeed(10);       //  λ¨ν„° μ¤ν”Όλ“ 
  Serial.begin(9600);          //  μ»΄ν“¨ν„° μ‹λ¦¬μ–Όν¬νΈ 

  pinMode(IRdetect, INPUT);    // IR κ±°λ¦¬μ„Όμ„ ν•€ μΈν’‹λ¨λ“
  pinMode(eatDetectpin, INPUT);   // λ¨Ήμ΄ν†µ μΈ΅μ •μ„Όμ„ κ°μ§€ν•€ μ…λ ¥λ¨λ“

}

void loop() {
  int IRstate = !digitalRead(IRdetect);     //  λ‚΄κ°€ κ°€μ§€κ³  μλ” μ μ™Έμ„  μ„Όμ„κ°€ νƒμ§€κ°’μ΄ 0 μ΄κ³  μ•νƒμ§€λκ² 1μ΄λΌ μ—­μΌλ΅ μ €μ¥ν•¨.
  //Serial.println(IRstate);                 //  μ μ™Έμ„  μ„Όμ„ κ°’ ν™•μΈμ© μ¶λ ¥ 

  if (previouslySenserVel != IRstate){      // 2μ„Όν‹°λ―Έν„° λ‹¨μ„ λ°”μ½”λ“κ°€ ν°μƒ‰μ—μ„ κ²€μ€μƒ‰, κ²€μ€μƒ‰μ—μ„ ν°μƒ‰μΌλ΅ λ°”λ€” λ• λ§λ‹¤ 1ν‹±μ”© μ¶”κ°€ 
    tick = tick + 1;
    previouslySenserVel = IRstate;
  }
  EatMotorSpin(); //---π’•π’•π’•--- μ‚¬μ΄ν΄λ§λ‹¤ λ¨ν„°λ¥Ό λλ¦¬λ” ν•¨μ 

  if(digitalRead(eatDetectpin) == 0){       // λ¨Ήμ΄ν†µ λΉκ±° κ°μ§€ν•λ” μ½”λ“ (μ •ν™•λ„ ν–¥μƒμ„ μ„ν•΄ μ—°μ†μΌλ΅ 10νκ°€ κ°μ§€λμ–΄μ•Όμ§€ λ¨Ήμ΄ν†µμ΄ λΉ„μ—λ‹¤λ” μ‹ νΈκ°€ κ°€λ„λ΅ λ§λ“¦)
    eatNoDetectCount =+ 1;                  // λ¨Ήμ΄ν†µμ΄ λΉ κ² κ°μ§€λλ©΄ λΉκ±° κ°μ§€λμ—λ‹¤λ” ν•¨μ 1νμ—…
    if (eatNoDetectCount > 10){             // 11ν μ—°μ†μΌλ΅ λ¨Ήμ΄ν†µ λΉ κ² κ°μ§€λλ©΄ μ‹¤ν–‰
      Serial.print("EMPTY");
      //--------------λ¨Ήμ΄ν†µμ΄ λΉ„μ—μµλ‹λ‹¤-------
      eatNoDetectCount = 0;                 // μ—°μ†κ°μ§€ λ³€μ μ΄κΈ°ν™”
    }
  }
  else if(digitalRead(eatDetectpin) == 1){
    eatNoDetectCount = 0;                   // μ—°μ†μΌλ΅ λ¨Ήμ΄ν†µμ λΉ κ°’μ΄ λ“¤μ–΄μ¤μ§€ μ•μΌλ©΄ λ¨Ήμ΄ν†µ λΉκ±° μ„Όμ„ μ—°μ†κ°μ§€ κ°’ μ΄κΈ°ν™”
  }

  //-------------------ν™•μΈμ© μ¶λ ¥--------------
  
 
  Serial.print(tick*2);
  Serial.println("cm");
 
}

void EatMotorSpin(void){                      // λ¨Ήμ΄ μ£Όλ” λ¨ν„° λλ¦¬λ” ν•¨μ

  if (tick != 0){                             // μ΄κΈ°κ°’ κ±΄λ„λ›°κΈ°
    if (IsMotorSpin == 1){                    // λ§μΌ μ΄λ―Έ λ¨ν„°κ°€ λμ•„κ°€λ” μ¤‘μ΄λΌλ©΄
      Serial.println("----E A T----");        // μ—¬κΈ°λ¶€ν„° λ¨Ήμ΄λ¥Ό μ¤„ λ• μ‹¤ν–‰λλ” μ½”λ“
      eatmotor.step(STEPS/1024);              // 2μ¤ν…μ”© λ¨ν„°λ¥Ό λλ¦¬λ” μ½”λ“
      HowMuchSpinMotor ++;                    // μ§€κΈκΉμ§€ λ‡ μ¤ν…μ„ λλ Έλ‚ μ €μ¥
      if(HowMuchSpinMotor == 256){            // λ¨ν„° 1/4 λ°”ν€΄ λ‹¤ λλ Έμ„λ• μ΄κΈ°ν™”
        IsMotorSpin = 0;
        HowMuchSpinMotor = 0;
      }
    }
    if (tick % eatCycle == 0){                // λ¨ν„°λ¥Ό λλ ¤μ•Ό ν•  λ•λ¥Ό νλ‹¨ν•κ³  μ €μ¥
      IsMotorSpin = 1;
      tick = tick + 1;                        // μ¤ν…λ¨ν„° κ³„μ†λμ•„κ°€μ§€ μ•κ² ν‹± 1ν μ¶”κ°€ν•λ” μ½”λ“
    }
  }
}
